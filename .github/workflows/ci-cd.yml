name: CI/CD Pipeline

on:
  push:
  pull_request:

jobs:
  # Continuous Integration
  buildAndTest:
    name: Run tests and code quality
    runs-on: ubuntu-22.04
    steps:
      - name: Check out the Git repository
        uses: actions/checkout@v4
      - name: Set up Java toolchain
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"
          cache: "gradle"
      - name: Make gradlew executable
        working-directory: ./apps/backend/
        run: chmod +x ./gradlew
      - name: Run unit tests and checkstyle linter
        working-directory: ./apps/backend/
        run: ./gradlew build

  security-analysis:
    name: Scorecard analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      id-token: write
      contents: read
      actions: read
    steps:
      - name: "Checkout code"
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - name: "Run analysis"
        uses: ossf/scorecard-action@f49aabe0b5af0936a0987cfb85d86b75731b0186 # v2.4.1
        with:
          results_file: results.sarif
          results_format: sarif
          publish_results: true
      - name: "Upload artifact"
        uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        with:
          name: SARIF file
          path: results.sarif
          retention-days: 5
      - name: "Upload to code-scanning"
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif

  backend-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Make gradlew executable
        working-directory: ./apps/backend/
        run: chmod +x ./gradlew

      - name: Build and Analyze
        working-directory: apps/backend/
        run: ./gradlew check jacocoTestReport

      - name: Upload SpotBugs SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/apps/backend/build/reports/spotbugs/main.sarif

      - name: Checkstyle PR Reviewer
        uses: dbelyaev/action-checkstyle@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: JaCoCo PR Report
        if: github.event_name == 'pull_request'
        uses: Madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/apps/backend/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 80
          title: 'Backend Test Coverage'

  frontend-analysis:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        working-directory: ${{ github.workspace }}/apps/frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ${{ github.workspace }}/apps/frontend
        run: |
          npm install @microsoft/eslint-formatter-sarif
          npx eslint . --format @microsoft/eslint-formatter-sarif --output-file eslint-results.sarif
        continue-on-error: true

      - name: Upload ESLint SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ github.workspace }}/apps/frontend/eslint-results.sarif

  dummy-deploy:
    needs: buildAndTest
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Check Quality Gate
        run: echo "Quality Gate Passed! Tests and Linter are clean."

      - name: Simulate Deployment to Staging
        if: github.ref == 'refs/heads/staging'
        run: |
          echo "Simulating deployment to STAGING Environment..."
          echo "Connecting to Server... [MOCK]"
          echo "Deployment Success!"

      - name: Simulate Deployment to Production
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Simulating deployment to PRODUCTION Environment..."
          echo "Connecting to Server... [MOCK]"
          echo "Deployment Success!"